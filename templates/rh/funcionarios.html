{% extends 'core/dashboard.html' %}
{% load static %}

{% block title %}Gestão de Funcionários - vistoGEST{% endblock %}

{% block extra_css %}
<style>
    .funcionario-card {
        transition: all 0.3s ease;
        border: 1px solid #e5e7eb;
    }
    .funcionario-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    .badge-cargo {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 9999px;
    }
    .modal-overlay {
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
    }
</style>
{% endblock %}

{% block main_content %}
<div id="funcionarios" class="module active">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Gestão de Funcionários</h1>
            <p class="text-gray-600 dark:text-gray-400">Controle completo de recursos humanos</p>
        </div>
        <div class="flex space-x-3">
            <button id="btnNovoFuncionario" class="bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded-lg transition-colors">
                <i class="fas fa-plus mr-2"></i>Novo Funcionário
            </button>
            <button id="btnExportarFuncionarios" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                <i class="fas fa-file-excel mr-2"></i>Exportar
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="stats-card p-6 rounded-xl">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-white/80 text-sm">Total Funcionários</p>
                    <p class="text-3xl font-bold text-white">{{ total_funcionarios }}</p>
                </div>
                <div class="bg-white/20 p-3 rounded-lg">
                    <i class="fas fa-users text-2xl text-white"></i>
                </div>
            </div>
        </div>

        <div class="bg-green-500 p-6 rounded-xl text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-white/80 text-sm">Funcionários Ativos</p>
                    <p class="text-3xl font-bold">{{ funcionarios_ativos }}</p>
                </div>
                <div class="bg-white/20 p-3 rounded-lg">
                    <i class="fas fa-user-check text-2xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-orange-500 p-6 rounded-xl text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-white/80 text-sm">Aniversariantes do Mês</p>
                    <p class="text-3xl font-bold">{{ aniversariantes_mes }}</p>
                </div>
                <div class="bg-white/20 p-3 rounded-lg">
                    <i class="fas fa-birthday-cake text-2xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-blue-500 p-6 rounded-xl text-white">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-white/80 text-sm">Departamentos</p>
                    <p class="text-3xl font-bold">{{ departamentos.count }}</p>
                </div>
                <div class="bg-white/20 p-3 rounded-lg">
                    <i class="fas fa-building text-2xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros e Busca -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm mb-6">
        <div class="flex flex-col md:flex-row gap-4">
            <div class="flex-1">
                <input type="text" id="buscarFuncionario" placeholder="Buscar por nome, CPF ou cargo..." 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
            </div>
            <div class="flex gap-3">
                <select id="filtroDepartamento" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                    <option value="">Todos os Departamentos</option>
                    {% for dept in departamentos %}
                    <option value="{{ dept.id }}">{{ dept.nome }}</option>
                    {% endfor %}
                </select>
                <select id="filtroStatus" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                    <option value="">Todos</option>
                    <option value="ativo">Ativos</option>
                    <option value="inativo">Inativos</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Lista de Funcionários -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="listaFuncionarios">
        {% for funcionario in funcionarios %}
        <div class="funcionario-card bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm" data-funcionario-id="{{ funcionario.id }}">
            <!-- Foto e Status -->
            <div class="flex items-center mb-4">
                <div class="w-16 h-16 bg-gray-300 rounded-full flex items-center justify-center mr-4">
                    {% if funcionario.foto %}
                    <img src="{{ funcionario.foto.url }}" alt="{{ funcionario.nome_completo }}" class="w-16 h-16 rounded-full object-cover">
                    {% else %}
                    <i class="fas fa-user text-2xl text-gray-600"></i>
                    {% endif %}
                </div>
                <div class="flex-1">
                    <h3 class="font-semibold text-gray-900 dark:text-white">{{ funcionario.nome_completo }}</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400">{{ funcionario.numero_funcionario }}</p>
                    <span class="badge-cargo bg-{{ funcionario.usuario.cargo|default:'gray' }}-100 text-{{ funcionario.usuario.cargo|default:'gray' }}-800">
                        {{ funcionario.usuario.get_cargo_display }}
                    </span>
                </div>
                <div class="text-right">
                    {% if funcionario.ativo %}
                    <span class="w-3 h-3 bg-green-500 rounded-full inline-block"></span>
                    {% else %}
                    <span class="w-3 h-3 bg-red-500 rounded-full inline-block"></span>
                    {% endif %}
                </div>
            </div>

            <!-- Informações -->
            <div class="space-y-2 mb-4">
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600 dark:text-gray-400">Departamento:</span>
                    <span class="text-gray-900 dark:text-white">{{ funcionario.departamento.nome }}</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600 dark:text-gray-400">Admissão:</span>
                    <span class="text-gray-900 dark:text-white">{{ funcionario.data_admissao|date:"d/m/Y" }}</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600 dark:text-gray-400">Tempo Empresa:</span>
                    <span class="text-gray-900 dark:text-white">{{ funcionario.tempo_empresa.days }} dias</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600 dark:text-gray-400">Telefone:</span>
                    <span class="text-gray-900 dark:text-white">{{ funcionario.telefone }}</span>
                </div>
            </div>

            <!-- Ações -->
            <div class="flex space-x-2">
                <button onclick="editarFuncionario({{ funcionario.id }})" 
                        class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 px-3 rounded-lg text-sm transition-colors">
                    <i class="fas fa-edit mr-1"></i>Editar
                </button>
                <button onclick="verDetalhes({{ funcionario.id }})" 
                        class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-3 rounded-lg text-sm transition-colors">
                    <i class="fas fa-eye mr-1"></i>Detalhes
                </button>
                {% if funcionario.ativo %}
                <button onclick="desativarFuncionario({{ funcionario.id }})" 
                        class="bg-red-500 hover:bg-red-600 text-white py-2 px-3 rounded-lg text-sm transition-colors">
                    <i class="fas fa-user-times"></i>
                </button>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal Novo/Editar Funcionário -->
<div id="modalFuncionario" class="fixed inset-0 modal-overlay hidden z-50 flex items-center justify-center">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto m-4">
        <div class="p-6 border-b border-gray-200 dark:border-gray-700">
            <div class="flex justify-between items-center">
                <h2 id="modalTitulo" class="text-xl font-bold text-gray-900 dark:text-white">Novo Funcionário</h2>
                <button onclick="fecharModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>

        <form id="formFuncionario" class="p-6">
            <input type="hidden" id="funcionarioId">
            
            <!-- Dados Pessoais -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Dados Pessoais</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nome Completo *</label>
                        <input type="text" id="nomeCompleto" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">CPF *</label>
                        <input type="text" id="cpf" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">RG</label>
                        <input type="text" id="rg" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Data Nascimento</label>
                        <input type="date" id="dataNascimento" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Estado Civil</label>
                        <select id="estadoCivil" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                            <option value="solteiro">Solteiro(a)</option>
                            <option value="casado">Casado(a)</option>
                            <option value="divorciado">Divorciado(a)</option>
                            <option value="viuvo">Viúvo(a)</option>
                            <option value="uniao_estavel">União Estável</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Escolaridade</label>
                        <select id="escolaridade" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                            <option value="fundamental">Ensino Fundamental</option>
                            <option value="medio">Ensino Médio</option>
                            <option value="tecnico">Técnico</option>
                            <option value="superior">Superior</option>
                            <option value="pos_graduacao">Pós-graduação</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Contato -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Contato</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Telefone *</label>
                        <input type="text" id="telefone" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label>
                        <input type="email" id="email" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Endereço Completo</label>
                        <textarea id="enderecoCompleto" rows="3" 
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"></textarea>
                    </div>
                </div>
            </div>

            <!-- Dados Profissionais -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Dados Profissionais</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Departamento *</label>
                        <select id="departamentoId" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                            <option value="">Selecione...</option>
                            {% for dept in departamentos %}
                            <option value="{{ dept.id }}">{{ dept.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Data Admissão</label>
                        <input type="date" id="dataAdmissao" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Salário Base *</label>
                        <input type="number" id="salarioBase" step="0.01" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                    </div>
                </div>
            </div>

            <!-- Botões -->
            <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                <button type="button" onclick="fecharModal()" 
                        class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">
                    Cancelar
                </button>
                <button type="submit" 
                        class="px-4 py-2 bg-primary hover:bg-primary-dark text-white rounded-lg transition-colors">
                    <i class="fas fa-save mr-2"></i>Salvar
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar funcionalidades
    initFuncionarios();
});

function initFuncionarios() {
    // Event listeners
    document.getElementById('btnNovoFuncionario').addEventListener('click', novoFuncionario);
    document.getElementById('formFuncionario').addEventListener('submit', salvarFuncionario);
    document.getElementById('buscarFuncionario').addEventListener('input', filtrarFuncionarios);
    document.getElementById('filtroDepartamento').addEventListener('change', filtrarFuncionarios);
    document.getElementById('filtroStatus').addEventListener('change', filtrarFuncionarios);
    
    // Máscaras
    aplicarMascaras();
}

function novoFuncionario() {
    document.getElementById('modalTitulo').textContent = 'Novo Funcionário';
    document.getElementById('funcionarioId').value = '';
    document.getElementById('formFuncionario').reset();
    document.getElementById('modalFuncionario').classList.remove('hidden');
}

function editarFuncionario(id) {
    document.getElementById('modalTitulo').textContent = 'Editar Funcionário';
    document.getElementById('funcionarioId').value = id;
    
    // Carregar dados do funcionário
    carregarDadosFuncionario(id);
    
    document.getElementById('modalFuncionario').classList.remove('hidden');
}

function carregarDadosFuncionario(id) {
    // Simulação - em produção fazer requisição AJAX
    const funcionario = window.funcionarios?.find(f => f.id === id);
    if (funcionario) {
        document.getElementById('nomeCompleto').value = funcionario.nome_completo;
        document.getElementById('cpf').value = funcionario.cpf;
        document.getElementById('rg').value = funcionario.rg;
        // ... outros campos
    }
}

async function salvarFuncionario(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const funcionarioId = document.getElementById('funcionarioId').value;
    
    const dados = {
        id: funcionarioId || null,
        nome_completo: document.getElementById('nomeCompleto').value,
        cpf: document.getElementById('cpf').value,
        rg: document.getElementById('rg').value,
        data_nascimento: document.getElementById('dataNascimento').value,
        estado_civil: document.getElementById('estadoCivil').value,
        escolaridade: document.getElementById('escolaridade').value,
        telefone: document.getElementById('telefone').value,
        email: document.getElementById('email').value,
        endereco_completo: document.getElementById('enderecoCompleto').value,
        departamento_id: document.getElementById('departamentoId').value,
        data_admissao: document.getElementById('dataAdmissao').value,
        salario_base: document.getElementById('salarioBase').value,
    };
    
    try {
        const response = await fetch('/rh/funcionarios/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            body: JSON.stringify(dados)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('Funcionário salvo com sucesso!', 'success');
            fecharModal();
            location.reload(); // Recarregar página
        } else {
            showToast('Erro ao salvar funcionário: ' + result.error, 'error');
        }
    } catch (error) {
        showToast('Erro de comunicação com o servidor', 'error');
        console.error('Erro:', error);
    }
}

function fecharModal() {
    document.getElementById('modalFuncionario').classList.add('hidden');
}

function filtrarFuncionarios() {
    const busca = document.getElementById('buscarFuncionario').value.toLowerCase();
    const departamento = document.getElementById('filtroDepartamento').value;
    const status = document.getElementById('filtroStatus').value;
    
    const funcionarios = document.querySelectorAll('.funcionario-card');
    
    funcionarios.forEach(card => {
        const texto = card.textContent.toLowerCase();
        const deptId = card.dataset.departamentoId;
        const ativo = card.dataset.ativo === 'true';
        
        let mostrar = true;
        
        // Filtro por busca
        if (busca && !texto.includes(busca)) {
            mostrar = false;
        }
        
        // Filtro por departamento
        if (departamento && deptId !== departamento) {
            mostrar = false;
        }
        
        // Filtro por status
        if (status === 'ativo' && !ativo) {
            mostrar = false;
        } else if (status === 'inativo' && ativo) {
            mostrar = false;
        }
        
        card.style.display = mostrar ? 'block' : 'none';
    });
}

function verDetalhes(id) {
    // Implementar modal de detalhes
    showToast('Detalhes do funcionário (em desenvolvimento)', 'info');
}

function desativarFuncionario(id) {
    if (confirm('Deseja realmente desativar este funcionário?')) {
        // Implementar desativação
        showToast('Funcionário desativado', 'info');
    }
}

function aplicarMascaras() {
    // Aplicar máscaras nos campos
    const cpfInput = document.getElementById('cpf');
    const telefoneInput = document.getElementById('telefone');
    
    if (cpfInput) {
        cpfInput.addEventListener('input', function() {
            this.value = this.value.replace(/\D/g, '').replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        });
    }
    
    if (telefoneInput) {
        telefoneInput.addEventListener('input', function() {
            this.value = this.value.replace(/\D/g, '').replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
        });
    }
}

function getCSRFToken() {
    return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
}

function showToast(message, type = 'info') {
    // Usar o sistema de toast do dashboard principal
    if (window.dashboard && window.dashboard.showToast) {
        window.dashboard.showToast(message, type);
    } else {
        alert(message);
    }
}
</script>
{% endblock %}