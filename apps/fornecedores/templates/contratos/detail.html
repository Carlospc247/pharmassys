{% extends "base.html" %}

{% block title %}Contrato #{{ contrato.numero_contrato }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Contrato #{{ contrato.numero_contrato }}</h2>
        <div class="btn-group">
            <a href="{% url 'fornecedores:contrato_editar' pk=contrato.pk %}" class="btn btn-info">
                <i class="fas fa-edit"></i> Editar
            </a>
            
            {# Ações Lógicas: Renovar e Encerrar #}
            {% if contrato.is_ativo or contrato.is_expirado %}
                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#modalEncerrar">
                    <i class="fas fa-ban"></i> Encerrar
                </button>
            {% endif %}

            {% if not contrato.is_ativo %}
                <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modalRenovar">
                    <i class="fas fa-redo"></i> Renovar
                </button>
            {% endif %}
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <span class="h5">Informações Chave</span>
            <span class="float-end badge bg-light text-dark">
                {% if contrato.is_ativo %}Vigente{% elif contrato.is_encerrado %}Encerrado{% elif contrato.is_expirado %}Expirado{% else %}Rascunho{% endif %}
            </span>
        </div>
        <div class="card-body">
            <dl class="row">
                <dt class="col-sm-4">Fornecedor:</dt>
                <dd class="col-sm-8">{{ contrato.fornecedor.nome_exibicao }}</dd>

                <dt class="col-sm-4">Tipo de Contrato:</dt>
                <dd class="col-sm-8">{{ contrato.get_tipo_display }}</dd>

                <dt class="col-sm-4">Início / Fim:</dt>
                <dd class="col-sm-8">
                    {{ contrato.data_inicio|date:"d/m/Y" }} 
                    {% if contrato.data_fim %}
                        a {{ contrato.data_fim|date:"d/m/Y" }}
                        {% if contrato.dias_restantes and contrato.dias_restantes <= 30 and contrato.is_ativo %}
                            <span class="text-warning fw-bold">(Expira em {{ contrato.dias_restantes }} dias)</span>
                        {% endif %}
                    {% else %}
                        (Prazo Indeterminado)
                    {% endif %}
                </dd>
                
                <dt class="col-sm-4">Valor Total:</dt>
                <dd class="col-sm-8">Kz {{ contrato.valor_contrato|floatformat:2|default:"0.00" }}</dd>
            </dl>
            
            <h5 class="mt-4 border-bottom pb-2">Termos e Condições</h5>
            <p>{{ contrato.termos_condicoes|linebreaksbr|default:"Nenhum termo detalhado." }}</p>
            
            <h5 class="mt-4 border-bottom pb-2">Observações</h5>
            <p>{{ contrato.observacoes|linebreaksbr|default:"Nenhuma." }}</p>
        </div>
    </div>

    <div class="mt-3">
        <a href="{% url 'fornecedores:contrato_lista' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar à Lista
        </a>
    </div>
</div>

{# Modal de Confirmação para Renovar #}
<div class="modal fade" id="modalRenovar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{% url 'fornecedores:contrato_renovar' pk=contrato.pk %}">
                {% csrf_token %}
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">Confirmação de Renovação</h5>
                </div>
                <div class="modal-body">
                    Confirma a **renovação** do contrato **#{{ contrato.numero_contrato }}**?
                    <p class="mt-2 text-muted">Esta ação irá replicar o contrato, ajustando as datas.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning">Renovar Contrato</button>
                </div>
            </form>
        </div>
    </div>
</div>

{# Modal de Confirmação para Encerrar #}
<div class="modal fade" id="modalEncerrar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="{% url 'fornecedores:contrato_encerrar' pk=contrato.pk %}">
                {% csrf_token %}
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Confirmação de Encerramento</h5>
                </div>
                <div class="modal-body">
                    Tem certeza que deseja **encerrar** o contrato **#{{ contrato.numero_contrato }}**?
                    <p class="mt-2 text-danger fw-bold">O status será alterado para 'Encerrado' e o contrato não será mais ativo.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Encerrar Contrato</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}