<!-- templates/fiscal/validacoes_dashboard.html -->
{% extends 'base.html' %}
{% load static %}

{% block title %}Validações Fiscais{% endblock %}

{% block breadcrumbs %}
<li><a href="{% url 'core:dashboard' %}" class="text-gray-400 hover:text-gray-500">
    <i class="fas fa-home h-5 w-5"></i>
</a></li>
<li class="flex items-center">
    <i class="fas fa-chevron-right h-5 w-5 text-gray-400 mx-2"></i>
    <a href="{% url 'fiscal:dashboard' %}" class="text-gray-500 dark:text-gray-400 hover:text-gray-700">Fiscal</a>
</li>
<li class="flex items-center">
    <i class="fas fa-chevron-right h-5 w-5 text-gray-400 mx-2"></i>
    <span class="text-gray-700 dark:text-gray-300 font-medium">Validações</span>
</li>
{% endblock %}

{% block page_title %}
<div class="flex items-center">
    <div class="flex-shrink-0">
        <div class="flex items-center justify-center w-12 h-12 bg-green-100 dark:bg-green-900 rounded-lg">
            <i class="fas fa-check-double text-green-600 dark:text-green-400 text-xl"></i>
        </div>
    </div>
    <div class="ml-4">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Validações Fiscais</h1>
        <p class="text-sm text-gray-500 dark:text-gray-400">Verificação de integridade e conformidade</p>
    </div>
</div>
{% endblock %}

{% block content %}
<div x-data="validacoesDashboard()" class="space-y-6">

    <!-- Status Geral -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Status da Assinatura -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center"
                         :class="statusAssinatura.configurada ? 'bg-green-100 dark:bg-green-900' : 'bg-red-100 dark:bg-red-900'">
                        <i :class="statusAssinatura.configurada ? 'fas fa-shield-alt text-green-600 dark:text-green-400' : 'fas fa-shield-alt text-red-600 dark:text-red-400'"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Assinatura Digital</p>
                    <p class="text-lg font-semibold" 
                       :class="statusAssinatura.configurada ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'"
                       x-text="statusAssinatura.configurada ? 'Configurada' : 'Não Configurada'"></p>
                </div>
            </div>
        </div>

        <!-- Última Validação -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center">
                        <i class="fas fa-clock text-blue-600 dark:text-blue-400"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Última Validação</p>
                    <p class="text-lg font-semibold text-gray-900 dark:text-gray-100">{{ ultima_validacao }}</p>
                </div>
            </div>
        </div>

        <!-- Documentos Válidos -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-purple-100 dark:bg-purple-900 rounded-full flex items-center justify-center">
                        <i class="fas fa-file-check text-purple-600 dark:text-purple-400"></i>
                    </div>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Documentos</p>
                    <p class="text-lg font-semibold text-gray-900 dark:text-gray-100" x-text="stats.documentosValidos + '/' + stats.totalDocumentos">0/0</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Ferramentas de Validação -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Validar Documentos -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">
                    <i class="fas fa-file-check mr-2 text-blue-500"></i>
                    Validar Documentos
                </h3>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                      :class="validacaoDocumentos.status === 'ok' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 
                              validacaoDocumentos.status === 'warning' ? 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200' :
                              'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'">
                    <i :class="validacaoDocumentos.status === 'ok' ? 'fas fa-check' : 
                               validacaoDocumentos.status === 'warning' ? 'fas fa-exclamation-triangle' : 
                               'fas fa-times'" class="mr-1"></i>
                    <span x-text="validacaoDocumentos.label"></span>
                </span>
            </div>
            
            <div class="space-y-4">
                <p class="text-sm text-gray-600 dark:text-gray-400">
                    Verifica a conformidade de todos os documentos fiscais emitidos.
                </p>
                
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                    <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-2">Última Verificação:</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-500 dark:text-gray-400">Documentos:</span>
                            <span class="ml-2 font-medium text-gray-900 dark:text-gray-100" x-text="validacaoDocumentos.total">0</span>
                        </div>
                        <div>
                            <span class="text-gray-500 dark:text-gray-400">Erros:</span>
                            <span class="ml-2 font-medium" 
                                  :class="validacaoDocumentos.erros > 0 ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'"
                                  x-text="validacaoDocumentos.erros">0</span>
                        </div>
                        <div>
                            <span class="text-gray-500 dark:text-gray-400">Avisos:</span>
                            <span class="ml-2 font-medium text-yellow-600 dark:text-yellow-400" x-text="validacaoDocumentos.avisos">0</span>
                        </div>
                        <div>
                            <span class="text-gray-500 dark:text-gray-400">Data:</span>
                            <span class="ml-2 font-medium text-gray-900 dark:text-gray-100" x-text="validacaoDocumentos.data">-</span>
                        </div>
                    </div>
                </div>
                
                <button @click="executarValidacaoDocumentos()" 
                        :disabled="validandoDocumentos"
                        class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 disabled:opacity-50">
                    <div x-show="!validandoDocumentos" class="flex items-center">
                        <i class="fas fa-play mr-2"></i>
                        Executar Validação
                    </div>
                    <div x-show="validandoDocumentos" class="flex items-center">
                        <svg class="animate-spin h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Validando...
                    </div>
                </button>
            </div>
        </div>

        <!-- Verificar Integridade -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">
                    <i class="fas fa-shield-check mr-2 text-green-500"></i>
                    Verificar Integridade
                </h3>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                      :class="verificacaoIntegridade.status === 'ok' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 
                              'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'">
                    <i :class="verificacaoIntegridade.status === 'ok' ? 'fas fa-check' : 'fas fa-times'" class="mr-1"></i>
                    <span x-text="verificacaoIntegridade.label"></span>
                </span>
            </div>
            
            <div class="space-y-4">
                <p class="text-sm text-gray-600 dark:text-gray-400">
                    Verifica a integridade da cadeia de hash dos documentos assinados.
                </p>
                
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                    <h4 class="text-sm font-medium text-gray-900 dark:text-gray-100 mb-2">Última Verificação:</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-gray-500 dark:text-gray-400">Séries:</span>
                            <span class="ml-2 font-medium text-gray-900 dark:text-gray-100" x-text="verificacaoIntegridade.series">0</span>
                        </div>
                        <div>
                            <span class="text-gray-500 dark:text-gray-400">Status:</span>
                            <span class="ml-2 font-medium" 
                                  :class="verificacaoIntegridade.integra ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'"
                                  x-text="verificacaoIntegridade.integra ? 'Íntegra' : 'Comprometida'"></span>
                        </div>
                        <div class="col-span-2">
                            <span class="text-gray-500 dark:text-gray-400">Último Hash:</span>
                            <span class="ml-2 font-mono text-xs text-gray-900 dark:text-gray-100 break-all" x-text="verificacaoIntegridade.ultimoHash">-</span>
                        </div>
                    </div>
                </div>
                
                <button @click="executarVerificacaoIntegridade()" 
                        :disabled="verificandoIntegridade"
                        class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 disabled:opacity-50">
                    <div x-show="!verificandoIntegridade" class="flex items-center">
                        <i class="fas fa-search mr-2"></i>
                        Verificar Integridade
                    </div>
                    <div x-show="verificandoIntegridade" class="flex items-center">
                        <svg class="animate-spin h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Verificando...
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Validador de Hash Manual -->
    <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-4">
            <i class="fas fa-calculator mr-2 text-purple-500"></i>
            Validador de Hash Manual
        </h3>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Documento ou Dados</label>
                <textarea x-model="hashValidator.documento" 
                          rows="4"
                          placeholder="Cole aqui o conteúdo do documento ou dados para gerar/verificar hash..."
                          class="w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700"></textarea>
                
                <div class="mt-4 flex space-x-3">
                    <button @click="gerarHash()" 
                            :disabled="!hashValidator.documento || geratingHash"
                            class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 disabled:opacity-50 text-sm">
                        <i class="fas fa-cog mr-1"></i>
                        Gerar Hash
                    </button>
                    
                    <button @click="verificarHash()" 
                            :disabled="!hashValidator.documento || !hashValidator.hashEsperado"
                            class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 text-sm">
                        <i class="fas fa-check mr-1"></i>
                        Verificar
                    </button>
                </div>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Hash Gerado/Esperado</label>
                <input type="text" 
                       x-model="hashValidator.hashEsperado"
                       placeholder="Hash SHA-256 para verificação..."
                       class="w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 font-mono text-sm">
                
                <div x-show="hashValidator.resultado" x-cloak class="mt-4 p-3 rounded-lg"
                     :class="hashValidator.valido ? 'bg-green-50 dark:bg-green-900 border border-green-200 dark:border-green-700' : 'bg-red-50 dark:bg-red-900 border border-red-200 dark:border-red-700'">
                    <div class="flex items-center">
                        <i :class="hashValidator.valido ? 'fas fa-check-circle text-green-500' : 'fas fa-times-circle text-red-500'" class="mr-2"></i>
                        <span class="text-sm font-medium" 
                              :class="hashValidator.valido ? 'text-green-800 dark:text-green-200' : 'text-red-800 dark:text-red-200'"
                              x-text="hashValidator.resultado"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alertas e Recomendações -->
    <div x-show="alertas.length > 0" class="space-y-4">
        <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Alertas e Recomendações</h3>
        <template x-for="alerta in alertas" :key="alerta.id">
            <div class="rounded-md p-4" :class="alerta.tipo === 'warning' ? 'bg-yellow-50 dark:bg-yellow-900 border border-yellow-200 dark:border-yellow-700' : 'bg-red-50 dark:bg-red-900 border border-red-200 dark:border-red-700'">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i :class="alerta.tipo === 'warning' ? 'fas fa-exclamation-triangle text-yellow-400' : 'fas fa-exclamation-circle text-red-400'" class="h-5 w-5"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium" :class="alerta.tipo === 'warning' ? 'text-yellow-800 dark:text-yellow-200' : 'text-red-800 dark:text-red-200'" x-text="alerta.titulo"></h3>
                        <div class="mt-2 text-sm" :class="alerta.tipo === 'warning' ? 'text-yellow-700 dark:text-yellow-300' : 'text-red-700 dark:text-red-300'">
                            <p x-text="alerta.mensagem"></p>
                        </div>
                        <div class="mt-4" x-show="alerta.acao">
                            <button @click="handleAlertAction(alerta)" 
                                    class="text-sm font-medium hover:underline"
                                    :class="alerta.tipo === 'warning' ? 'text-yellow-800 dark:text-yellow-200' : 'text-red-800 dark:text-red-200'">
                                <span x-text="alerta.textoAcao"></span>
                                <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script>
function validacoesDashboard() {
    return {
        statusAssinatura: {
            configurada: {% if assinatura %}true{% else %}false{% endif %}
        },
        stats: {
            documentosValidos: 0,
            totalDocumentos: 0
        },
        validacaoDocumentos: {
            status: 'pending',
            label: 'Pendente',
            total: 0,
            erros: 0,
            avisos: 0,
            data: '-'
        },
        verificacaoIntegridade: {
            status: 'pending',
            label: 'Pendente',
            series: 0,
            integra: false,
            ultimoHash: '-'
        },
        hashValidator: {
            documento: '',
            hashEsperado: '',
            resultado: '',
            valido: false
        },
        validandoDocumentos: false,
        verificandoIntegridade: false,
        geratingHash: false,
        alertas: [],

        init() {
            this.loadInitialData();
            this.checkAlertas();
        },

        async loadInitialData() {
            // Carregar status inicial das validações
            await this.loadValidacaoStatus();
            await this.loadIntegridadeStatus();
        },

        async loadValidacaoStatus() {
            try {
                const response = await fetch('{% url "fiscal:ajax-dados-dashboard" %}');
                const data = await response.json();
                
                if (data.success && data.validacao_status) {
                    this.validacaoDocumentos = { ...this.validacaoDocumentos, ...data.validacao_status };
                }
            } catch (error) {
                console.error('Erro ao carregar status de validação:', error);
            }
        },

        async loadIntegridadeStatus() {
            try {
                const response = await fetch('{% url "fiscal:ajax-status-assinatura" %}');
                const data = await response.json();
                
                if (data.success) {
                    this.verificacaoIntegridade.ultimoHash = data.data.ultimo_hash || '-';
                    this.verificacaoIntegridade.status = data.data.ultimo_hash ? 'ok' : 'error';
                    this.verificacaoIntegridade.label = data.data.ultimo_hash ? 'Verificada' : 'Não Verificada';
                }
            } catch (error) {
                console.error('Erro ao carregar status de integridade:', error);
            }
        },

        async executarValidacaoDocumentos() {
            this.validandoDocumentos = true;
            
            try {
                const response = await fetch('{% url "fiscal:validar-documentos-web" %}');
                const data = await response.json();
                
                if (data.status === 'sucesso') {
                    this.validacaoDocumentos.status = data.erros > 0 ? 'error' : (data.avisos > 0 ? 'warning' : 'ok');
                    this.validacaoDocumentos.label = data.erros > 0 ? 'Erros Encontrados' : (data.avisos > 0 ? 'Avisos' : 'Válido');
                    this.validacaoDocumentos.erros = data.erros || 0;
                    this.validacaoDocumentos.avisos = data.avisos || 0;
                    this.validacaoDocumentos.total = data.total || 0;
                    this.validacaoDocumentos.data = new Date().toLocaleString('pt-PT');
                } else {
                    this.validacaoDocumentos.status = 'error';
                    this.validacaoDocumentos.label = 'Erro na Validação';
                }
            } catch (error) {
                console.error('Erro na validação de documentos:', error);
                this.validacaoDocumentos.status = 'error';
                this.validacaoDocumentos.label = 'Erro de Conexão';
            } finally {
                this.validandoDocumentos = false;
            }
        },

        async executarVerificacaoIntegridade() {
            this.verificandoIntegridade = true;
            
            try {
                const response = await fetch('{% url "fiscal:verificar-integridade-web" %}');
                const data = await response.json();
                
                if (data.ok) {
                    this.verificacaoIntegridade.status = 'ok';
                    this.verificacaoIntegridade.label = 'Íntegra';
                    this.verificacaoIntegridade.integra = true;
                    this.verificacaoIntegridade.series = Object.keys(data.series_fiscais || {}).length;
                } else {
                    this.verificacaoIntegridade.status = 'error';
                    this.verificacaoIntegridade.label = 'Comprometida';
                    this.verificacaoIntegridade.integra = false;
                }
            } catch (error) {
                console.error('Erro na verificação de integridade:', error);
                this.verificacaoIntegridade.status = 'error';
                this.verificacaoIntegridade.label = 'Erro de Conexão';
            } finally {
                this.verificandoIntegridade = false;
            }
        },

        async gerarHash() {
            if (!this.hashValidator.documento) return;
            
            this.geratingHash = true;
            
            try {
                const response = await fetch('{% url "fiscal:ajax-gerar-hash" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: new URLSearchParams({
                        'dados': this.hashValidator.documento
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    this.hashValidator.hashEsperado = data.hash;
                    this.hashValidator.resultado = 'Hash gerado com sucesso';
                    this.hashValidator.valido = true;
                } else {
                    this.hashValidator.resultado = 'Erro ao gerar hash';
                    this.hashValidator.valido = false;
                }
            } catch (error) {
                console.error('Erro ao gerar hash:', error);
                this.hashValidator.resultado = 'Erro de conexão';
                this.hashValidator.valido = false;
            } finally {
                this.geratingHash = false;
            }
        },

        async verificarHash() {
            if (!this.hashValidator.documento || !this.hashValidator.hashEsperado) return;
            
            try {
                const response = await fetch('{% url "fiscal:ajax-verificar-documento" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: new URLSearchParams({
                        'hash': this.hashValidator.hashEsperado
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    this.hashValidator.valido = data.valid;
                    this.hashValidator.resultado = data.valid ? 'Hash válido - Documento íntegro' : 'Hash inválido - Documento pode ter sido alterado';
                } else {
                    this.hashValidator.valido = false;
                    this.hashValidator.resultado = 'Erro na verificação do hash';
                }
            } catch (error) {
                console.error('Erro ao verificar hash:', error);
                this.hashValidator.valido = false;
                this.hashValidator.resultado = 'Erro de conexão na verificação';
            }
        },

        checkAlertas() {
            this.alertas = [];
            
            if (!this.statusAssinatura.configurada) {
                this.alertas.push({
                    id: 1,
                    tipo: 'error',
                    titulo: 'Assinatura Digital Não Configurada',
                    mensagem: 'Configure a assinatura digital para garantir a integridade dos documentos fiscais.',
                    acao: true,
                    textoAcao: 'Configurar Agora'
                });
            }

            if (this.validacaoDocumentos.erros > 0) {
                this.alertas.push({
                    id: 2,
                    tipo: 'error',
                    titulo: 'Documentos com Erros',
                    mensagem: `${this.validacaoDocumentos.erros} documento(s) contêm erros que precisam ser corrigidos.`,
                    acao: true,
                    textoAcao: 'Ver Detalhes'
                });
            }

            if (this.validacaoDocumentos.avisos > 0) {
                this.alertas.push({
                    id: 3,
                    tipo: 'warning',
                    titulo: 'Documentos com Avisos',
                    mensagem: `${this.validacaoDocumentos.avisos} documento(s) contêm avisos que devem ser revisados.`,
                    acao: true,
                    textoAcao: 'Revisar'
                });
            }
        },

        handleAlertAction(alerta) {
            switch (alerta.id) {
                case 1:
                    window.location.href = '{% url "fiscal:assinatura-digital" %}';
                    break;
                case 2:
                case 3:
                    this.executarValidacaoDocumentos();
                    break;
            }
        }
    }
}
</script>
{% endblock %}