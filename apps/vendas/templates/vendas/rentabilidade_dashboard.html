{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard de Rentabilidade e Lucro{% endblock %}
{% block page_title %}Análise de Margem Bruta{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
    <h2 class="text-xl font-semibold leading-7 text-gray-900 dark:text-white mb-6">Visualização de Lucro por Produto</h2>
    
    <div class="bg-white dark:bg-gray-800 shadow p-6 mb-8 rounded-lg flex gap-4 items-end">
        <div>
            <label for="data_inicio" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Data Início</label>
            <input type="date" id="data_inicio" class="mt-1 block w-48 rounded-md border-gray-300 shadow-sm dark:bg-gray-700 dark:border-gray-600">
        </div>
        <div>
            <label for="data_fim" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Data Fim</label>
            <input type="date" id="data_fim" class="mt-1 block w-48 rounded-md border-gray-300 shadow-sm dark:bg-gray-700 dark:border-gray-600">
        </div>
        <button id="btn-filtrar" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none">
            Aplicar Filtros
        </button>
    </div>

    <div class="bg-white dark:bg-gray-800 shadow overflow-hidden sm:rounded-lg p-6 mb-8">
        <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Top 10 Produtos por Margem Bruta</h3>
        <canvas id="rentabilidadeChart" height="100"></canvas>
        <p id="feedback-chart" class="mt-4 text-sm text-center text-gray-500 dark:text-gray-400">A carregar dados...</p>
    </div>

    <div class="bg-white dark:bg-gray-800 shadow overflow-hidden sm:rounded-lg">
        <h3 class="text-lg font-medium text-gray-900 dark:text-white p-6 border-b dark:border-gray-700">Tabela de Rentabilidade Detalhada</h3>
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-gray-50 dark:bg-gray-700">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Produto</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Total Vendas (AKZ)</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Custo Total (CMV)</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider font-bold">MARGEM BRUTA (AKZ)</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider font-bold">% MARGEM</th>
                </tr>
            </thead>
            <tbody id="rentabilidade-tabela" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                </tbody>
        </table>
    </div>
</div>
{% endblock content %}

{% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    
    <script>
        const API_URL = '/api/v1/relatorios/rentabilidade/'; 
        const chartElement = document.getElementById('rentabilidadeChart');
        const tabelaBody = document.getElementById('rentabilidade-tabela');
        const feedbackChart = document.getElementById('feedback-chart');
        const btnFiltrar = document.getElementById('btn-filtrar');
        let rentabilidadeChart = null; // Para armazenar a instância do Chart

        // Função principal para buscar e renderizar dados
        async function fetchAndRenderData() {
            feedbackChart.textContent = 'A carregar dados de rentabilidade...';
            btnFiltrar.disabled = true;

            const dataInicio = document.getElementById('data_inicio').value;
            const dataFim = document.getElementById('data_fim').value;

            let url = API_URL;
            // Adicionar filtros à URL
            const params = new URLSearchParams();
            if (dataInicio) params.append('data_inicio', dataInicio);
            if (dataFim) params.append('data_fim', dataFim);
            if (params.toString()) {
                url += `?${params.toString()}`;
            }

            try {
                const response = await fetch(url);
                const data = await response.json();
                
                if (response.ok && data.relatorio_de_rentabilidade && data.relatorio_de_rentabilidade.length > 0) {
                    const relatorio = data.relatorio_de_rentabilidade;
                    
                    // Renderizar Gráfico
                    renderChart(relatorio);
                    
                    // Renderizar Tabela
                    renderTable(relatorio);
                    
                    feedbackChart.textContent = `Dados carregados. Período: ${dataInicio || 'Início'} a ${dataFim || 'Hoje'}.`;
                } else {
                    renderChart([]); // Limpar gráfico
                    renderTable([]); // Limpar tabela
                    feedbackChart.textContent = 'Nenhum dado de rentabilidade encontrado para os filtros aplicados.';
                }
            } catch (error) {
                console.error("Erro ao carregar dados de rentabilidade:", error);
                feedbackChart.textContent = 'Erro crítico ao comunicar com a API. Verifique o backend.';
            } finally {
                btnFiltrar.disabled = false;
            }
        }

        // Função de Geração de Gráfico
        function renderChart(relatorio) {
            if (rentabilidadeChart) {
                rentabilidadeChart.destroy(); // Destruir instância anterior
            }
            
            // Preparar dados para o gráfico (Top 10)
            const topProdutos = relatorio.slice(0, 10);
            const labels = topProdutos.map(p => p.produto_nome);
            const margens = topProdutos.map(p => parseFloat(p.margem_bruta).toFixed(2));
            const percentuais = topProdutos.map(p => parseFloat(p.percentual_margem_bruta).toFixed(2));

            rentabilidadeChart = new Chart(chartElement, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Margem Bruta (AKZ)',
                        data: margens,
                        backgroundColor: 'rgba(79, 70, 229, 0.7)', // Indigo
                        borderColor: 'rgb(79, 70, 229)',
                        borderWidth: 1,
                        yAxisID: 'y'
                    },
                    {
                        label: '% Margem Bruta',
                        data: percentuais,
                        type: 'line', // Linha para o percentual
                        borderColor: 'rgb(220, 38, 38)', // Vermelho (Alerta)
                        backgroundColor: 'rgba(220, 38, 38, 0.5)',
                        yAxisID: 'y1',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Lucro (AKZ)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: { drawOnChartArea: false }, // Ocultar grade para o eixo secundário
                            title: { display: true, text: 'Percentual (%)' },
                            ticks: { callback: (value) => value + "%" }
                        }
                    }
                }
            });
        }

        // Função de Geração de Tabela (Dados Acionáveis)
        function renderTable(relatorio) {
            tabelaBody.innerHTML = ''; // Limpar tabela
            
            relatorio.forEach(item => {
                const row = tabelaBody.insertRow();
                // Formatação para moeda Angolana (AKZ)
                const formatCurrency = (value) => `AKZ ${parseFloat(value).toLocaleString('pt-AO', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${item.produto_nome}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${formatCurrency(item.total_vendido)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-300">${formatCurrency(item.custo_total)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${item.margem_bruta < 0 ? 'text-red-500' : 'text-green-600'}">${formatCurrency(item.margem_bruta)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold ${item.percentual_margem_bruta < 10 ? 'text-red-500' : 'text-green-600'}">${parseFloat(item.percentual_margem_bruta).toFixed(2)}%</td>
                `;
            });
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            fetchAndRenderData();
        });
        
        btnFiltrar.addEventListener('click', fetchAndRenderData);

    </script>
{% endblock scripts %}