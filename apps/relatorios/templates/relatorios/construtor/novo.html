<!-- templates/relatorios/construtor/novo.html -->
{% extends "base.html" %}
{% load static %}

{% block title %}Novo Template de Relatório{% endblock %}

{% block extra_css %}
<style>
.field-builder {
    min-height: 400px;
    border: 2px dashed #d1d5db;
    border-radius: 0.5rem;
}

.field-item {
    transition: all 0.2s ease;
}

.field-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.sortable-ghost {
    opacity: 0.4;
}

.sortable-chosen {
    transform: rotate(5deg);
}
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900">
    <!-- Header -->
    <div class="bg-white dark:bg-gray-800 shadow">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div>
                    <nav class="flex" aria-label="Breadcrumb">
                        <ol class="flex items-center space-x-4">
                            <li>
                                <a href="{% url 'relatorios:dashboard' %}" class="text-gray-400 hover:text-gray-500">
                                    <i class="fas fa-chart-bar"></i>
                                </a>
                            </li>
                            <li>
                                <div class="flex items-center">
                                    <i class="fas fa-chevron-right text-gray-400 mr-4"></i>
                                    <a href="{% url 'relatorios:construtor' %}" class="text-gray-400 hover:text-gray-500">Construtor</a>
                                </div>
                            </li>
                            <li>
                                <div class="flex items-center">
                                    <i class="fas fa-chevron-right text-gray-400 mr-4"></i>
                                    <span class="ml-4 text-sm font-medium text-gray-500 dark:text-gray-400">Novo Template</span>
                                </div>
                            </li>
                        </ol>
                    </nav>
                    <h1 class="mt-2 text-3xl font-bold text-gray-900 dark:text-white">
                        <i class="fas fa-plus text-green-500 mr-3"></i>
                        Novo Template de Relatório
                    </h1>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                        Configure os campos, filtros e layout do seu relatório personalizado
                    </p>
                </div>
            </div>
        </div>
    </div>

    <form method="post" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {% csrf_token %}
        
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- Formulário Principal -->
            <div class="lg:col-span-3 space-y-6">
                <!-- Informações Básicas -->
                <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
                            Informações Básicas
                        </h3>
                    </div>
                    
                    <div class="p-6 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="{{ form.nome.id_for_label }}" 
                                       class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                    {{ form.nome.label }}
                                </label>
                                {{ form.nome }}
                                {% if form.nome.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.nome.errors.0 }}</p>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label for="{{ form.categoria.id_for_label }}" 
                                       class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                    {{ form.categoria.label }}
                                </label>
                                {{ form.categoria }}
                                {% if form.categoria.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.categoria.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div>
                            <label for="{{ form.descricao.id_for_label }}" 
                                   class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                {{ form.descricao.label }}
                            </label>
                            {{ form.descricao }}
                            {% if form.descricao.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.descricao.errors.0 }}</p>
                            {% endif %}
                        </div>
                        
                        <div>
                            <label for="{{ form.modelo_base.id_for_label }}" 
                                   class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                {{ form.modelo_base.label }}
                            </label>
                            {{ form.modelo_base }}
                            {% if form.modelo_base.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.modelo_base.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Construtor de Campos -->
                <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
                            Campos do Relatório
                        </h3>
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                            Arraste os campos disponíveis para a área de construção
                        </p>
                    </div>
                    
                    <div class="p-6">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Campos Disponíveis -->
                            <div>
                                <h4 class="text-sm font-medium text-gray-900 dark:text-white mb-3">
                                    Campos Disponíveis
                                </h4>
                                <div id="campos-disponiveis" class="space-y-2 max-h-96 overflow-y-auto">
                                    <!-- Campos serão carregados via JavaScript -->
                                </div>
                            </div>
                            
                            <!-- Área de Construção -->
                            <div class="lg:col-span-2">
                                <h4 class="text-sm font-medium text-gray-900 dark:text-white mb-3">
                                    Campos Selecionados
                                </h4>
                                <div id="campos-selecionados" 
                                     class="field-builder bg-gray-50 dark:bg-gray-700 p-4 min-h-96">
                                    <div class="text-center text-gray-500 dark:text-gray-400 py-12" id="empty-state">
                                        <i class="fas fa-mouse-pointer text-4xl mb-4"></i>
                                        <p>Arraste campos aqui para construir seu relatório</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configurações de Filtros -->
                <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
                            Filtros Disponíveis
                        </h3>
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                            Configure quais filtros estarão disponíveis na execução do relatório
                        </p>
                    </div>
                    
                    <div class="p-6">
                        <div id="filtros-container" class="space-y-4">
                            <!-- Filtros serão adicionados dinamicamente -->
                        </div>
                        
                        <button type="button" 
                                class="mt-4 inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600"
                                onclick="adicionarFiltro()">
                            <i class="fas fa-plus mr-2"></i>
                            Adicionar Filtro
                        </button>
                    </div>
                </div>

                <!-- Configurações de Layout -->
                <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
                            Layout e Formatação
                        </h3>
                    </div>
                    
                    <div class="p-6 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="{{ form.formato_padrao.id_for_label }}" 
                                       class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                    {{ form.formato_padrao.label }}
                                </label>
                                {{ form.formato_padrao }}
                            </div>
                            
                            <div>
                                <label for="{{ form.ordenacao_padrao.id_for_label }}" 
                                       class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                    {{ form.ordenacao_padrao.label }}
                                </label>
                                {{ form.ordenacao_padrao }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Preview -->
                <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-4">
                            Preview
                        </h3>
                        
                        <div id="preview-container" class="border border-gray-200 dark:border-gray-700 rounded-md p-4 min-h-32 bg-gray-50 dark:bg-gray-700">
                            <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-8">
                                Adicione campos para ver o preview
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Ações -->
                <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <div class="space-y-3">
                            <button type="submit" 
                                    class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                <i class="fas fa-save mr-2"></i>
                                Salvar Template
                            </button>
                            
                            <button type="button" 
                                    class="w-full inline-flex justify-center items-center px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600"
                                    onclick="previewRelatorio()">
                                <i class="fas fa-eye mr-2"></i>
                                Testar Template
                            </button>
                            
                            <a href="{% url 'relatorios:construtor' %}" 
                               class="w-full inline-flex justify-center items-center px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                                <i class="fas fa-times mr-2"></i>
                                Cancelar
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Ajuda -->
                <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
                    <div class="px-4 py-5 sm:p-6">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-4">
                            <i class="fas fa-question-circle text-blue-500 mr-2"></i>
                            Ajuda
                        </h3>
                        
                        <div class="space-y-3 text-sm text-gray-600 dark:text-gray-300">
                            <div>
                                <p class="font-medium">Dica 1:</p>
                                <p>Arraste campos da lista para a área de construção na ordem desejada.</p>
                            </div>
                            
                            <div>
                                <p class="font-medium">Dica 2:</p>
                                <p>Configure filtros para permitir que usuários personalizem os dados.</p>
                            </div>
                            
                            <div>
                                <p class="font-medium">Dica 3:</p>
                                <p>Use o preview para verificar como o relatório ficará antes de salvar.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

<script>
let camposSelecionados = [];
let filtrosAdicionados = [];

// Inicializar quando a página carrega
document.addEventListener('DOMContentLoaded', function() {
    carregarCamposDisponiveis();
    inicializarSortable();
    
    // Listener para mudança de modelo
    document.getElementById('id_modelo_base').addEventListener('change', function() {
        carregarCamposDisponiveis();
    });
});

function carregarCamposDisponiveis() {
    const modelo = document.getElementById('id_modelo_base').value;
    if (!modelo) return;
    
    fetch(`/relatorios/campos-disponiveis/?model=${modelo}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderizarCamposDisponiveis(data.campos);
            }
        })
        .catch(error => {
            console.error('Erro ao carregar campos:', error);
        });
}

function renderizarCamposDisponiveis(campos) {
    const container = document.getElementById('campos-disponiveis');
    container.innerHTML = '';
    
    campos.forEach(campo => {
        const div = document.createElement('div');
        div.className = 'field-item bg-white dark:bg-gray-600 border border-gray-200 dark:border-gray-500 rounded-md p-3 cursor-move hover:bg-gray-50 dark:hover:bg-gray-500';
        div.draggable = true;
        div.dataset.campo = JSON.stringify(campo);
        
        div.innerHTML = `
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-900 dark:text-white">${campo.verbose_name}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">${campo.name} (${campo.type})</p>
                </div>
                <i class="fas fa-grip-vertical text-gray-400"></i>
            </div>
        `;
        
        container.appendChild(div);
    });
}

function inicializarSortable() {
    const camposDisponiveis = document.getElementById('campos-disponiveis');
    const camposSelecionadosEl = document.getElementById('campos-selecionados');
    
    Sortable.create(camposDisponiveis, {
        group: {
            name: 'campos',
            pull: 'clone',
            put: false
        },
        sort: false
    });
    
    Sortable.create(camposSelecionadosEl, {
        group: 'campos',
        onAdd: function(evt) {
            const campo = JSON.parse(evt.item.dataset.campo);
            adicionarCampoSelecionado(campo, evt.item);
            atualizarPreview();
        },
        onUpdate: function(evt) {
            atualizarOrdemCampos();
            atualizarPreview();
        }
    });
}

function adicionarCampoSelecionado(campo, element) {
    const emptyState = document.getElementById('empty-state');
    if (emptyState) {
        emptyState.remove();
    }
    
    // Reconstruir o elemento com controles adicionais
    element.innerHTML = `
        <div class="bg-white dark:bg-gray-600 border border-gray-200 dark:border-gray-500 rounded-md p-4">
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <p class="text-sm font-medium text-gray-900 dark:text-white">${campo.verbose_name}</p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">${campo.name}</p>
                </div>
                <div class="flex items-center space-x-2">
                    <button type="button" class="text-gray-400 hover:text-gray-500" onclick="configurarCampo(this)" title="Configurar">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button type="button" class="text-red-400 hover:text-red-500" onclick="removerCampo(this)" title="Remover">
                        <i class="fas fa-trash"></i>
                    </button>
                    <i class="fas fa-grip-vertical text-gray-400 cursor-move"></i>
                </div>
            </div>
        </div>
    `;
    
    camposSelecionados.push(campo);
}

function removerCampo(button) {
    const fieldItem = button.closest('.field-item');
    fieldItem.remove();
    
    // Verificar se não há mais campos
    const container = document.getElementById('campos-selecionados');
    if (container.children.length === 0) {
        container.innerHTML = `
            <div class="text-center text-gray-500 dark:text-gray-400 py-12" id="empty-state">
                <i class="fas fa-mouse-pointer text-4xl mb-4"></i>
                <p>Arraste campos aqui para construir seu relatório</p>
            </div>
        `;
    }
    
    atualizarOrdemCampos();
    atualizarPreview();
}

function configurarCampo(button) {
    // Implementar modal de configuração do campo
    alert('Configuração de campo - implementar modal');
}

function atualizarOrdemCampos() {
    const container = document.getElementById('campos-selecionados');
    const campos = Array.from(container.children).filter(child => 
        child.classList.contains('field-item')
    );
    
    camposSelecionados = campos.map(campo => {
        return JSON.parse(campo.dataset.campo);
    });
}

function atualizarPreview() {
    const previewContainer = document.getElementById('preview-container');
    
    if (camposSelecionados.length === 0) {
        previewContainer.innerHTML = `
            <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-8">
                Adicione campos para ver o preview
            </p>
        `;
        return;
    }
    
    let previewHTML = '<table class="min-w-full text-xs"><thead class="bg-gray-100 dark:bg-gray-600"><tr>';
    
    camposSelecionados.forEach(campo => {
        previewHTML += `<th class="px-2 py-1 text-left font-medium text-gray-900 dark:text-white">${campo.verbose_name}</th>`;
    });
    
    previewHTML += '</tr></thead><tbody><tr>';
    
    camposSelecionados.forEach(() => {
        previewHTML += '<td class="px-2 py-1 text-gray-500 dark:text-gray-400">Exemplo</td>';
    });
    
    previewHTML += '</tr></tbody></table>';
    
    previewContainer.innerHTML = previewHTML;
}

function adicionarFiltro() {
    const container = document.getElementById('filtros-container');
    const filtroId = `filtro_${filtrosAdicionados.length}`;
    
    const filtroHTML = `
        <div class="border border-gray-200 dark:border-gray-700 rounded-md p-4" id="${filtroId}">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Campo</label>
                    <select class="mt-1 text-base block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-white">
                        <option value="">Selecione um campo</option>
                        ${camposSelecionados.map(campo => 
                            `<option value="${campo.name}">${campo.verbose_name}</option>`
                        ).join('')}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tipo</label>
                    <select class="mt-1 text-base block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-white">
                        <option value="texto">Texto</option>
                        <option value="data">Data</option>
                        <option value="numero">Número</option>
                        <option value="escolha">Lista de Opções</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button type="button" class="w-full inline-flex justify-center items-center px-3 py-2 border border-red-300 rounded-md shadow-sm text-sm font-medium text-red-700 bg-white hover:bg-red-50"
                            onclick="removerFiltro('${filtroId}')">
                        <i class="fas fa-trash mr-1"></i>
                        Remover
                    </button>
                </div>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', filtroHTML);
    filtrosAdicionados.push(filtroId);
}

function removerFiltro(filtroId) {
    document.getElementById(filtroId).remove();
    filtrosAdicionados = filtrosAdicionados.filter(id => id !== filtroId);
}

function previewRelatorio() {
    if (camposSelecionados.length === 0) {
        alert('Adicione pelo menos um campo antes de testar o template');
        return;
    }
    
    // Implementar preview do relatório
    alert('Preview do relatório - implementar');
}
</script>
{% endblock %}