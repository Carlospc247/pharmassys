{% extends "base.html" %}
{% load humanize %}
{% load static %}

{% block title %}Relatórios de Vendas{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="px-6 py-6">
  <h2 class="text-3xl font-bold text-indigo-700 mb-8 flex items-center gap-2">
    <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 17l6-6 4 4 8-8" />
    </svg>
    Relatórios de Vendas
  </h2>

  <!-- KPIs -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="bg-white rounded-2xl shadow-md p-5 border-l-4 border-green-500">
      <p class="text-gray-500">Vendas Hoje</p>
      <h3 class="text-2xl font-semibold text-green-600">AKZ {{ vendas_hoje.total|floatformat:2|default:"0,00"|intcomma }}
      <p class="text-sm text-gray-500">{{ vendas_hoje.quantidade|default:"0" }} vendas</p>
    </div>

    <div class="bg-white rounded-2xl shadow-md p-5 border-l-4 border-blue-500">
      <p class="text-gray-500">Vendas no Mês</p>
      <h3 class="text-2xl font-semibold text-blue-600">{{ vendas_mes.total_vendas|default:0|floatformat:2|intcomma }} Kz</h3>
      <p class="text-sm text-gray-500">Ticket médio: {{ vendas_mes.ticket_medio|default:0|floatformat:2|intcomma }} Kz</p>
    </div>

    <div class="bg-white rounded-2xl shadow-md p-5 border-l-4 border-indigo-500">
      <p class="text-gray-500">Vendas no Ano</p>
      <h3 class="text-2xl font-semibold text-indigo-600">{{ vendas_ano.total_vendas|default:0|floatformat:2|intcomma }} Kz</h3>
      <p class="text-sm text-gray-500">{{ vendas_ano.quantidade|default:0 }} vendas</p>
    </div>

    <div class="bg-white rounded-2xl shadow-md p-5 border-l-4 {% if crescimento_mes >= 0 %}border-green-600{% else %}border-red-500{% endif %}">
      <p class="text-gray-500">Crescimento Mensal</p>
      <h3 class="text-2xl font-semibold {% if crescimento_mes >= 0 %}text-green-600{% else %}text-red-500{% endif %}">
        {{ crescimento_mes|floatformat:1 }}%
      </h3>
      <p class="text-sm text-gray-500">vs mês anterior</p>
    </div>
  </div>

  <!-- Gráficos -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="col-span-2 bg-white rounded-2xl shadow-md p-5">
      <h4 class="text-lg font-semibold text-indigo-700 mb-4">Vendas Diárias (Últimos 30 dias)</h4>
      <canvas id="vendasPorDiaChart" height="120"></canvas>
    </div>

    <div class="bg-white rounded-2xl shadow-md p-5">
      <h4 class="text-lg font-semibold text-indigo-700 mb-4">Formas de Pagamento</h4>
      <canvas id="pagamentosChart" height="120"></canvas>
    </div>
  </div>

  <!-- Top produtos -->
  <div class="bg-white rounded-2xl shadow-md p-6 mb-8">
    <h4 class="text-lg font-semibold text-indigo-700 mb-4 flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h18M3 12h18m-9 5h9" />
      </svg>
      Top 10 Produtos Vendidos
    </h4>

    <div class="overflow-x-auto">
      <table class="min-w-full border-gray-100">
        <thead class="bg-gray-50 text-gray-600 text-sm">
          <tr>
            <th class="text-left py-2 px-3">#</th>
            <th class="text-left py-2 px-3">Produto</th>
            <th class="text-left py-2 px-3">Qtd</th>
            <th class="text-left py-2 px-3">Faturamento (Kz)</th>
            <th class="text-left py-2 px-3">Vendas</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          {% for p in top_produtos %}
          <tr class="hover:bg-gray-50">
            <td class="py-2 px-3">{{ forloop.counter }}</td>
            <td class="py-2 px-3">{{ p.nome_produto }}</td>
            <td class="py-2 px-3">{{ p.quantidade_vendida }}</td>
            <td class="py-2 px-3">{{ p.faturamento|floatformat:2|intcomma }}</td>
    
          </tr>
          {% empty %}
          <tr><td colspan="5" class="text-center py-4 text-gray-400">Sem dados</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Vendas por vendedor -->
  <div class="bg-white rounded-2xl shadow-md p-6 mb-8">
    <h4 class="text-lg font-semibold text-indigo-700 mb-4">Vendas por Vendedor</h4>
    <div class="overflow-x-auto">
      <table class="min-w-full border-gray-100">
        <thead class="bg-gray-50 text-gray-600 text-sm">
          <tr>
            <th class="text-left py-2 px-3">Vendedor</th>
            <th class="text-left py-2 px-3">Total</th>
            <th class="text-left py-2 px-3">Faturamento (Kz)</th>
            <th class="text-left py-2 px-3">Ticket Médio (Kz)</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-100">
          {% for v in vendas_por_vendedor %}
          <tr class="hover:bg-gray-50">
            <td class="py-2 px-3">{{ v.vendedor__nome_completo }}</td>
            <td class="py-2 px-3">{{ v.total_vendas }}</td>
            <td class="py-2 px-3">{{ v.faturamento|floatformat:2|intcomma }}</td>
            <td class="py-2 px-3">{{ v.ticket_medio|floatformat:2|intcomma }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="4" class="text-center py-4 text-gray-400">Sem dados</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Meta mensal -->
  {% if meta_mes %}
  <div class="bg-white rounded-2xl shadow-md p-6 mb-8">
    <h4 class="text-lg font-semibold text-indigo-700 mb-4">Meta Mensal</h4>
    <div class="w-full bg-gray-100 rounded-full h-5 overflow-hidden">
      <div class="bg-green-500 h-5 text-xs font-semibold text-white flex items-center justify-center" style="width: {{ percentual_meta }}%;">
        {{ percentual_meta|floatformat:1 }}%
      </div>
    </div>
    <p class="text-gray-500 text-sm mt-2">Meta: {{ meta_mes.valor_meta|floatformat:2|intcomma }} Kz</p>
  </div>
  {% endif %}

  <!-- Produtos com baixo giro -->
  <div class="bg-yellow-100 text-yellow-800 p-4 rounded-2xl shadow-sm flex items-center gap-2">
    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 20h0" />
    </svg>
    <span><strong>{{ produtos_baixo_giro }}</strong> produtos não venderam neste mês.</span>
  </div>
</div>

<script>
  const vendasLabels = [{% for v in vendas_por_dia %}"{{ v.data_venda|date:'d/m' }}",{% endfor %}];
  const vendasData = [{% for v in vendas_por_dia %}{{ v.total|default:0 }},{% endfor %}];

  new Chart(document.getElementById('vendasPorDiaChart'), {
    type: 'line',
    data: {
      labels: vendasLabels,
      datasets: [{
        label: 'Faturamento (Kz)',
        data: vendasData,
        borderColor: '#4f46e5',
        backgroundColor: 'rgba(79,70,229,0.1)',
        tension: 0.4,
        fill: true
      }]
    },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });

  const pagamentosLabels = [{% for f in vendas_forma_pagamento %}"{{ f.forma_pagamento }}",{% endfor %}];
  const pagamentosData = [{% for f in vendas_forma_pagamento %}{{ f.total|default:0 }},{% endfor %}];

  new Chart(document.getElementById('pagamentosChart'), {
    type: 'doughnut',
    data: {
      labels: pagamentosLabels,
      datasets: [{
        data: pagamentosData,
        backgroundColor: ['#22c55e','#3b82f6','#f59e0b','#ef4444','#8b5cf6']
      }]
    },
    options: { responsive: true }
  });
</script>
{% endblock %}
