<!-- templates/relatorios/agendamento/lista.html -->
{% extends "base.html" %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900">
    <!-- Header -->
    <div class="bg-white dark:bg-gray-800 shadow">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div>
                    <nav class="flex" aria-label="Breadcrumb">
                        <ol class="flex items-center space-x-4">
                            <li>
                                <a href="{% url 'relatorios:dashboard' %}" class="text-gray-400 hover:text-gray-500">
                                    <i class="fas fa-chart-bar"></i>
                                </a>
                            </li>
                            <li>
                                <div class="flex items-center">
                                    <i class="fas fa-chevron-right text-gray-400 mr-4"></i>
                                    <span class="ml-4 text-sm font-medium text-gray-500 dark:text-gray-400">Agendamentos</span>
                                </div>
                            </li>
                        </ol>
                    </nav>
                    <h1 class="mt-2 text-3xl font-bold text-gray-900 dark:text-white">
                        <i class="fas fa-clock text-blue-500 mr-3"></i>
                        Agendamentos de Relatórios
                    </h1>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                        Gerencie execuções programadas e automáticas dos seus relatórios
                    </p>
                </div>
                <div class="flex space-x-3">
                    <a href="{% url 'relatorios:agendamento_create' %}" 
                       class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 transition-colors">
                        <i class="fas fa-plus mr-2"></i>
                        Novo Agendamento
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Estatísticas de Agendamentos -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center">
                            <i class="fas fa-calendar-check text-blue-600 dark:text-blue-400"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Ativos</h3>
                        <p class="text-2xl font-semibold text-gray-900 dark:text-white">
                            {{ stats.total_ativos }}
                        </p>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center">
                            <i class="fas fa-play text-green-600 dark:text-green-400"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Execuções Hoje</h3>
                        <p class="text-2xl font-semibold text-gray-900 dark:text-white">
                            {{ stats.execucoes_hoje }}
                        </p>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 bg-yellow-100 dark:bg-yellow-900 rounded-lg flex items-center justify-center">
                            <i class="fas fa-clock text-yellow-600 dark:text-yellow-400"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Próximas 24h</h3>
                        <p class="text-2xl font-semibold text-gray-900 dark:text-white">
                            {{ stats.proximas_24h }}
                        </p>
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-10 h-10 bg-red-100 dark:bg-red-900 rounded-lg flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-red-600 dark:text-red-400"></i>
                        </div>
                    </div>
                    <div class="ml-4">
                        <h3 class="text-sm font-medium text-gray-500 dark:text-gray-400">Com Falhas</h3>
                        <p class="text-2xl font-semibold text-gray-900 dark:text-white">
                            {{ stats.com_falhas }}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg mb-6">
            <div class="px-6 py-4">
                <form method="get" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Status
                        </label>
                        <select name="status"
                                class="text-base w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-white">
                            <option value="">Todos</option>
                            <option value="ativo" {% if filtros.status == 'ativo' %}selected{% endif %}>Ativo</option>
                            <option value="inativo" {% if filtros.status == 'inativo' %}selected{% endif %}>Inativo</option>
                            <option value="pausado" {% if filtros.status == 'pausado' %}selected{% endif %}>Pausado</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Frequência
                        </label>
                        <select name="frequencia"
                                class="text-base w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-white">
                            <option value="">Todas</option>
                            <option value="diaria" {% if filtros.frequencia == 'diaria' %}selected{% endif %}>Diária</option>
                            <option value="semanal" {% if filtros.frequencia == 'semanal' %}selected{% endif %}>Semanal</option>
                            <option value="mensal" {% if filtros.frequencia == 'mensal' %}selected{% endif %}>Mensal</option>
                            <option value="personalizada" {% if filtros.frequencia == 'personalizada' %}selected{% endif %}>Personalizada</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
                            Template
                        </label>
                        <select name="template"
                                class="text-base w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-white">
                            <option value="">Todos</option>
                            {% for template in templates_disponiveis %}
                            <option value="{{ template.id }}" {% if filtros.template == template.id|stringformat:"s" %}selected{% endif %}>
                                {{ template.nome }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="flex items-end space-x-2">
                        <button type="submit" 
                                class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                            <i class="fas fa-search mr-2"></i>
                            Filtrar
                        </button>
                        <a href="{% url 'relatorios:agendamento_lista' %}" 
                           class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                            <i class="fas fa-times mr-2"></i>
                            Limpar
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Lista de Agendamentos -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
            {% if agendamentos %}
            <div class="divide-y divide-gray-200 dark:divide-gray-700">
                {% for agendamento in agendamentos %}
                <div class="p-6 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="flex-shrink-0">
                                <div class="w-12 h-12 rounded-lg flex items-center justify-center
                                    {% if agendamento.ativo and not agendamento.pausado %}
                                        bg-green-100 dark:bg-green-900
                                    {% elif agendamento.pausado %}
                                        bg-yellow-100 dark:bg-yellow-900
                                    {% else %}
                                        bg-gray-100 dark:bg-gray-700
                                    {% endif %}">
                                    {% if agendamento.ativo and not agendamento.pausado %}
                                        <i class="fas fa-play text-green-600 dark:text-green-400"></i>
                                    {% elif agendamento.pausado %}
                                        <i class="fas fa-pause text-yellow-600 dark:text-yellow-400"></i>
                                    {% else %}
                                        <i class="fas fa-stop text-gray-400"></i>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="flex-1">
                                <h4 class="text-lg font-medium text-gray-900 dark:text-white">
                                    {{ agendamento.nome }}
                                </h4>
                                
                                <div class="mt-1 flex items-center space-x-4 text-sm text-gray-500 dark:text-gray-400">
                                    <span class="flex items-center">
                                        <i class="fas fa-file-alt mr-1"></i>
                                        {{ agendamento.template.nome }}
                                    </span>
                                    
                                    <span class="flex items-center">
                                        <i class="fas fa-redo mr-1"></i>
                                        {{ agendamento.get_frequencia_display }}
                                    </span>
                                    
                                    {% if agendamento.proximo_agendamento %}
                                    <span class="flex items-center">
                                        <i class="fas fa-clock mr-1"></i>
                                        Próxima: {{ agendamento.proximo_agendamento|date:"d/m/Y H:i" }}
                                    </span>
                                    {% endif %}
                                </div>
                                
                                <div class="mt-2 flex items-center space-x-2">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                        {% if agendamento.ativo and not agendamento.pausado %}
                                            bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100
                                        {% elif agendamento.pausado %}
                                            bg-yellow-100 text-yellow-800 dark:bg-yellow-800 dark:text-yellow-100
                                        {% else %}
                                            bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200
                                        {% endif %}">
                                        {% if agendamento.ativo and not agendamento.pausado %}
                                            Ativo
                                        {% elif agendamento.pausado %}
                                            Pausado
                                        {% else %}
                                            Inativo
                                        {% endif %}
                                    </span>
                                    
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-800 dark:text-blue-100">
                                        {{ agendamento.formato|upper }}
                                    </span>
                                    
                                    {% if agendamento.enviar_email %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-800 dark:text-purple-100">
                                        <i class="fas fa-envelope mr-1"></i>
                                        Email
                                    </span>
                                    {% endif %}
                                </div>
                                
                                <!-- Estatísticas de Execução -->
                                <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                                    <span>{{ agendamento.total_execucoes }} execuções</span>
                                    {% if agendamento.ultima_execucao %}
                                    <span class="ml-2">• Última: {{ agendamento.ultima_execucao|date:"d/m H:i" }}</span>
                                    {% endif %}
                                    {% if agendamento.ultima_execucao_status %}
                                    <span class="ml-2 font-medium
                                        {% if agendamento.ultima_execucao_status == 'concluido' %}text-green-600
                                        {% elif agendamento.ultima_execucao_status == 'erro' %}text-red-600
                                        {% else %}text-yellow-600{% endif %}">
                                        ({{ agendamento.get_ultima_execucao_status_display }})
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-3">
                            <!-- Botão de Executar Agora -->
                            {% if agendamento.ativo %}
                            <button type="button" 
                                    class="inline-flex items-center px-3 py-2 border border-green-300 text-sm leading-4 font-medium rounded-md text-green-700 bg-white hover:bg-green-50 transition-colors"
                                    onclick="executarAgora({{ agendamento.id }})">
                                <i class="fas fa-play mr-1"></i>
                                Executar
                            </button>
                            {% endif %}
                            
                            <!-- Botão de Pausar/Reativar -->
                            {% if agendamento.ativo %}
                                {% if agendamento.pausado %}
                                <button type="button" 
                                        class="inline-flex items-center px-3 py-2 border border-blue-300 text-sm leading-4 font-medium rounded-md text-blue-700 bg-white hover:bg-blue-50 transition-colors"
                                        onclick="reativarAgendamento({{ agendamento.id }})">
                                    <i class="fas fa-play mr-1"></i>
                                    Reativar
                                </button>
                                {% else %}
                                <button type="button" 
                                        class="inline-flex items-center px-3 py-2 border border-yellow-300 text-sm leading-4 font-medium rounded-md text-yellow-700 bg-white hover:bg-yellow-50 transition-colors"
                                        onclick="pausarAgendamento({{ agendamento.id }})">
                                    <i class="fas fa-pause mr-1"></i>
                                    Pausar
                                </button>
                                {% endif %}
                            {% endif %}
                            
                            <div class="relative" x-data="{ open: false }">
                                <button @click="open = !open" 
                                        class="p-2 text-gray-400 hover:text-gray-500 rounded-full hover:bg-gray-100 dark:hover:bg-gray-600">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                
                                <div x-show="open" 
                                     @click.away="open = false"
                                     x-transition
                                     class="origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white dark:bg-gray-700 ring-1 ring-black ring-opacity-5 z-10">
                                    <div class="py-1">
                                        <a href="{% url 'relatorios:agendamento_detail' agendamento.pk %}" 
                                           class="flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">
                                            <i class="fas fa-eye mr-2"></i>
                                            Ver Detalhes
                                        </a>
                                        <a href="{% url 'relatorios:agendamento_edit' agendamento.pk %}" 
                                           class="flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">
                                            <i class="fas fa-edit mr-2"></i>
                                            Editar
                                        </a>
                                        <a href="{% url 'relatorios:agendamento_historico' agendamento.pk %}" 
                                           class="flex items-center px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600">
                                            <i class="fas fa-history mr-2"></i>
                                            Histórico
                                        </a>
                                        <button type="button" 
                                                class="flex items-center w-full px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600"
                                                onclick="duplicarAgendamento({{ agendamento.id }})">
                                            <i class="fas fa-copy mr-2"></i>
                                            Duplicar
                                        </button>
                                        <hr class="my-1 border-gray-200 dark:border-gray-600">
                                        <button type="button" 
                                                class="flex items-center w-full px-4 py-2 text-sm text-red-700 dark:text-red-400 hover:bg-gray-100 dark:hover:bg-gray-600"
                                                onclick="excluirAgendamento({{ agendamento.id }}, '{{ agendamento.nome }}')">
                                            <i class="fas fa-trash mr-2"></i>
                                            Excluir
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Paginação -->
            {% if is_paginated %}
            <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                        <div>
                            <p class="text-sm text-gray-700 dark:text-gray-300">
                                Mostrando <span class="font-medium">{{ page_obj.start_index }}</span> a 
                                <span class="font-medium">{{ page_obj.end_index }}</span> de 
                                <span class="font-medium">{{ paginator.count }}</span> resultados
                            </p>
                        </div>
                        
                        <div>
                            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
                                {% if page_obj.has_previous %}
                                <a href="?page={{ page_obj.previous_page_number }}&{{ request.GET.urlencode }}" 
                                   class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                                {% endif %}
                                
                                {% for num in page_obj.paginator.page_range %}
                                    {% if page_obj.number == num %}
                                    <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-indigo-50 text-sm font-medium text-indigo-600">
                                        {{ num }}
                                    </span>
                                    {% else %}
                                    <a href="?page={{ num }}&{{ request.GET.urlencode }}" 
                                       class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                                        {{ num }}
                                    </a>
                                    {% endif %}
                                {% endfor %}
                                
                                {% if page_obj.has_next %}
                                <a href="?page={{ page_obj.next_page_number }}&{{ request.GET.urlencode }}" 
                                   class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                                {% endif %}
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            {% else %}
            <!-- Estado vazio -->
            <div class="p-12 text-center">
                <i class="fas fa-clock text-gray-400 text-6xl mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-2">
                    Nenhum agendamento encontrado
                </h3>
                <p class="text-gray-500 dark:text-gray-400 mb-6">
                    {% if request.GET %}
                        Nenhum agendamento corresponde aos filtros aplicados.
                    {% else %}
                        Você ainda não criou nenhum agendamento de relatório.
                    {% endif %}
                </p>
                {% if not request.GET %}
                <a href="{% url 'relatorios:agendamento_create' %}" 
                   class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                    <i class="fas fa-plus mr-2"></i>
                    Criar Primeiro Agendamento
                </a>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- Próximas Execuções -->
        {% if proximas_execucoes %}
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg mt-8">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
                    Próximas Execuções (24h)
                </h3>
            </div>
            <div class="divide-y divide-gray-200 dark:divide-gray-700">
                {% for execucao in proximas_execucoes|slice:":10" %}
                <div class="p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="flex-shrink-0">
                                <i class="fas fa-clock text-blue-500"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-900 dark:text-white">
                                    {{ execucao.agendamento.nome }}
                                </p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">
                                    {{ execucao.agendamento.template.nome }}
                                </p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-sm font-medium text-gray-900 dark:text-white">
                                {{ execucao.data_agendamento|date:"d/m/Y" }}
                            </p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">
                                {{ execucao.data_agendamento|time:"H:i" }}
                            </p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

<script>
function executarAgora(agendamentoId) {
    if (showConfirmDialog('Deseja executar este agendamento agora?', () => {
        fetch(`/relatorios/agendamentos/${agendamentoId}/executar/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Relatório adicionado à fila de execução!');
                // Opcional: redirecionar para o histórico
                setTimeout(() => {
                    window.location.href = `/relatorios/historico/?agendamento=${agendamentoId}`;
                }, 2000);
            } else {
                showAlert('Erro ao executar agendamento: ' + data.error);
            }
        })
        .catch(error => {
            showAlert('Erro ao executar agendamento: ' + error);
        });
    })) {
        // Callback executado quando confirmado
    }
}

function pausarAgendamento(agendamentoId) {
    if (showConfirmDialog('Deseja pausar este agendamento?', () => {
        fetch(`/relatorios/agendamentos/${agendamentoId}/pausar/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                showAlert('Erro ao pausar agendamento: ' + data.error);
            }
        })
        .catch(error => {
            showAlert('Erro ao pausar agendamento: ' + error);
        });
    })) {
        // Callback executado quando confirmado
    }
}

function reativarAgendamento(agendamentoId) {
    if (showConfirmDialog('Deseja reativar este agendamento?', () => {
        fetch(`/relatorios/agendamentos/${agendamentoId}/reativar/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                showAlert('Erro ao reativar agendamento: ' + data.error);
            }
        })
        .catch(error => {
            showAlert('Erro ao reativar agendamento: ' + error);
        });
    })) {
        // Callback executado quando confirmado
    }
}

function duplicarAgendamento(agendamentoId) {
    if (showConfirmDialog('Deseja duplicar este agendamento?', () => {
        fetch(`/relatorios/agendamentos/${agendamentoId}/duplicar/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.href = `/relatorios/agendamentos/${data.novo_agendamento_id}/editar/`;
            } else {
                showAlert('Erro ao duplicar agendamento: ' + data.error);
            }
        })
        .catch(error => {
            showAlert('Erro ao duplicar agendamento: ' + error);
        });
    })) {
        // Callback executado quando confirmado
    }
}

function excluirAgendamento(agendamentoId, nome) {
    if (showConfirmDialog(`Tem certeza que deseja excluir o agendamento "${nome}"?`, () => {
        fetch(`/relatorios/agendamentos/${agendamentoId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                showAlert('Erro ao excluir agendamento: ' + data.error);
            }
        })
        .catch(error => {
            showAlert('Erro ao excluir agendamento: ' + error);
        });
    })) {
        // Callback executado quando confirmado
    }
}

// Funções de modal customizadas
function showConfirmDialog(message, onConfirm) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
            <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
            <div class="flex justify-end space-x-3">
                <button class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded" onclick="this.closest('.fixed').remove()">Cancelar</button>
                <button class="px-4 py-2 bg-indigo-500 text-white hover:bg-indigo-600 rounded" onclick="this.closest('.fixed').remove(); onConfirm()">Confirmar</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    return true;
}

function showAlert(message) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
            <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
            <div class="flex justify-end">
                <button class="px-4 py-2 bg-blue-500 text-white hover:bg-blue-600 rounded" onclick="this.closest('.fixed').remove()">OK</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}
</script>
{% endblock %}