<!-- templates/relatorios/agendamento/create.html -->
{% extends "base.html" %}
{% load static %}

{% block title %}Novo Agendamento{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50 dark:bg-gray-900">
    <!-- Header -->
    <div class="bg-white dark:bg-gray-800 shadow">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-6">
                <div>
                    <nav class="flex" aria-label="Breadcrumb">
                        <ol class="flex items-center space-x-4">
                            <li>
                                <a href="{% url 'relatorios:dashboard' %}" class="text-gray-400 hover:text-gray-500">
                                    <i class="fas fa-chart-bar"></i>
                                </a>
                            </li>
                            <li>
                                <div class="flex items-center">
                                    <i class="fas fa-chevron-right text-gray-400 mr-4"></i>
                                    <a href="{% url 'relatorios:agendamento_lista' %}" class="text-gray-400 hover:text-gray-500">Agendamentos</a>
                                </div>
                            </li>
                            <li>
                                <div class="flex items-center">
                                    <i class="fas fa-chevron-right text-gray-400 mr-4"></i>
                                    <span class="ml-4 text-sm font-medium text-gray-500 dark:text-gray-400">Novo</span>
                                </div>
                            </li>
                        </ol>
                    </nav>
                    <h1 class="mt-2 text-3xl font-bold text-gray-900 dark:text-white">
                        <i class="fas fa-plus text-green-500 mr-3"></i>
                        Novo Agendamento
                    </h1>
                    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                        Configure a execução automática de relatórios
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <form method="post" id="form-agendamento">
            {% csrf_token %}
            
            <div class="space-y-6">
                <!-- Informações Básicas -->
                <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
                            Informações Básicas
                        </h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="nome" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                    Nome do Agendamento
                                </label>
                                <input type="text" name="nome" id="nome" 
                                       value="{{ form.nome.value|default:'' }}"
                                       class="text-base mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-white"
                                       required>
                                {% if form.nome.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.nome.errors.0 }}</p>
                                {% endif %}
                            </div>
                            
                            <div>
                                <label for="template" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                    Template do Relatório
                                </label>
                                <select name="template" id="template" 
                                        class="text-base mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-white"
                                        required onchange="carregarConfiguracoes()">
                                    <option value="">Selecione um template</option>
                                    {% for template in templates_disponiveis %}
                                    <option value="{{ template.id }}" {% if form.template.value == template.id|stringformat:"s" %}selected{% endif %}>
                                        {{ template.nome }} ({{ template.categoria|capfirst }})
                                    </option>
                                    {% endfor %}
                                </select>
                                {% if form.template.errors %}
                                <p class="mt-1 text-sm text-red-600">{{ form.template.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div>
                            <label for="descricao" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                Descrição (opcional)
                            </label>
                            <textarea name="descricao" id="descricao" rows="3"
                                      class="text-base mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-white"
                                      placeholder="Descreva o propósito deste agendamento...">{{ form.descricao.value|default:'' }}</textarea>
                            {% if form.descricao.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.descricao.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Configurações de Horário -->
                <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
                            Configurações de Horário
                        </h3>
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                            Defina quando e com que frequência o relatório será executado
                        </p>
                    </div>
                    <div class="p-6 space-y-6">
                        <!-- Frequência -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-4">
                                Frequência de Execução
                            </label>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div class="relative">
                                    <input type="radio" id="freq_unica" name="frequencia" value="unica" 
                                           {% if form.frequencia.value == 'unica' or not form.frequencia.value %}checked{% endif %}
                                           class="sr-only peer" onchange="alterarFrequencia('unica')">
                                    <label for="freq_unica" 
                                           class="flex flex-col p-4 border-2 border-gray-200 dark:border-gray-700 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 peer-checked:border-indigo-500 peer-checked:bg-indigo-50 dark:peer-checked:bg-indigo-900">
                                        <div class="flex items-center justify-center mb-2">
                                            <i class="fas fa-play text-indigo-500 text-xl"></i>
                                        </div>
                                        <h4 class="text-sm font-medium text-gray-900 dark:text-white text-center">
                                            Execução Única
                                        </h4>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 text-center">
                                            Uma vez apenas
                                        </p>
                                    </label>
                                </div>
                                
                                <div class="relative">
                                    <input type="radio" id="freq_diaria" name="frequencia" value="diaria" 
                                           {% if form.frequencia.value == 'diaria' %}checked{% endif %}
                                           class="sr-only peer" onchange="alterarFrequencia('diaria')">
                                    <label for="freq_diaria" 
                                           class="flex flex-col p-4 border-2 border-gray-200 dark:border-gray-700 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 peer-checked:border-indigo-500 peer-checked:bg-indigo-50 dark:peer-checked:bg-indigo-900">
                                        <div class="flex items-center justify-center mb-2">
                                            <i class="fas fa-calendar-day text-indigo-500 text-xl"></i>
                                        </div>
                                        <h4 class="text-sm font-medium text-gray-900 dark:text-white text-center">
                                            Diária
                                        </h4>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 text-center">
                                            Todos os dias
                                        </p>
                                    </label>
                                </div>
                                
                                <div class="relative">
                                    <input type="radio" id="freq_semanal" name="frequencia" value="semanal" 
                                           {% if form.frequencia.value == 'semanal' %}checked{% endif %}
                                           class="sr-only peer" onchange="alterarFrequencia('semanal')">
                                    <label for="freq_semanal" 
                                           class="flex flex-col p-4 border-2 border-gray-200 dark:border-gray-700 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 peer-checked:border-indigo-500 peer-checked:bg-indigo-50 dark:peer-checked:bg-indigo-900">
                                        <div class="flex items-center justify-center mb-2">
                                            <i class="fas fa-calendar-week text-indigo-500 text-xl"></i>
                                        </div>
                                        <h4 class="text-sm font-medium text-gray-900 dark:text-white text-center">
                                            Semanal
                                        </h4>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 text-center">
                                            Toda semana
                                        </p>
                                    </label>
                                </div>
                                
                                <div class="relative">
                                    <input type="radio" id="freq_mensal" name="frequencia" value="mensal" 
                                           {% if form.frequencia.value == 'mensal' %}checked{% endif %}
                                           class="sr-only peer" onchange="alterarFrequencia('mensal')">
                                    <label for="freq_mensal" 
                                           class="flex flex-col p-4 border-2 border-gray-200 dark:border-gray-700 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 peer-checked:border-indigo-500 peer-checked:bg-indigo-50 dark:peer-checked:bg-indigo-900">
                                        <div class="flex items-center justify-center mb-2">
                                            <i class="fas fa-calendar-alt text-indigo-500 text-xl"></i>
                                        </div>
                                        <h4 class="text-sm font-medium text-gray-900 dark:text-white text-center">
                                            Mensal
                                        </h4>
                                        <p class="text-xs text-gray-500 dark:text-gray-400 text-center">
                                            Todo mês
                                        </p>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Configurações Específicas por Frequência -->
                        <div id="config-horario">
                            <!-- Execução Única -->
                            <div id="config-unica" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="data_execucao" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        Data de Execução
                                    </label>
                                    <input type="date" name="data_execucao" id="data_execucao" 
                                           value="{{ form.data_execucao.value|date:'Y-m-d'|default:'' }}"
                                           min="{{ today|date:'Y-m-d' }}"
                                           class="text-base mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-white">
                                </div>
                                <div>
                                    <label for="hora_execucao" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        Horário
                                    </label>
                                    <input type="time" name="hora_execucao" id="hora_execucao" 
                                           value="{{ form.hora_execucao.value|time:'H:i'|default:'09:00' }}"
                                           class="text-base mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-white">
                                </div>
                            </div>
                            
                            <!-- Diária -->
                            <div id="config-diaria" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="hora_diaria" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        Horário Diário
                                    </label>
                                    <input type="time" name="hora_diaria" id="hora_diaria" 
                                           value="{{ form.hora_diaria.value|time:'H:i'|default:'09:00' }}"
                                           class="text-base mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-white">
                                </div>
                                <div>
                                    <label for="data_inicio" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        Data de Início
                                    </label>
                                    <input type="date" name="data_inicio" id="data_inicio" 
                                           value="{{ form.data_inicio.value|date:'Y-m-d'|default:'' }}"
                                           min="{{ today|date:'Y-m-d' }}"
                                           class="text-base mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-white">
                                </div>
                            </div>
                            
                            <!-- Semanal -->
                            <div id="config-semanal" class="hidden space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">
                                        Dias da Semana
                                    </label>
                                    <div class="grid grid-cols-7 gap-2">
                                        {% for dia in dias_semana %}
                                        <label class="flex flex-col items-center p-2 border border-gray-200 dark:border-gray-600 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700">
                                            <input type="checkbox" name="dias_semana" value="{{ dia.0 }}" 
                                                   class="mb-1" {% if dia.0 in form.dias_semana.value %}checked{% endif %}>
                                            <span class="text-xs text-gray-700 dark:text-gray-300">{{ dia.1 }}</span>
                                        </label>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="hora_semanal" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                            Horário
                                        </label>
                                        <input type="time" name="hora_semanal" id="hora_semanal" 
                                               value="{{ form.hora_semanal.value|time:'H:i'|default:'09:00' }}"
                                               class="text-base mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-white">
                                    </div>
                                    <div>
                                        <label for="data_inicio_semanal" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                            Data de Início
                                        </label>
                                        <input type="date" name="data_inicio_semanal" id="data_inicio_semanal" 
                                               value="{{ form.data_inicio_semanal.value|date:'Y-m-d'|default:'' }}"
                                               min="{{ today|date:'Y-m-d' }}"
                                               class="text-base mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-white">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Mensal -->
                            <div id="config-mensal" class="hidden space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label for="dia_mes" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                            Dia do Mês
                                        </label>
                                        <select name="dia_mes" id="dia_mes" 
                                                class="text-base mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-white">
                                            {% for dia in dias_mes %}
                                            <option value="{{ dia }}" {% if form.dia_mes.value == dia|stringformat:"s" %}selected{% endif %}>
                                                Dia {{ dia }}
                                            </option>
                                            {% endfor %}
                                            <option value="ultimo" {% if form.dia_mes.value == 'ultimo' %}selected{% endif %}>
                                                Último dia
                                            </option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="hora_mensal" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                            Horário
                                        </label>
                                        <input type="time" name="hora_mensal" id="hora_mensal" 
                                               value="{{ form.hora_mensal.value|time:'H:i'|default:'09:00' }}"
                                               class="text-base mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-white">
                                    </div>
                                    <div>
                                        <label for="data_inicio_mensal" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                            Data de Início
                                        </label>
                                        <input type="date" name="data_inicio_mensal" id="data_inicio_mensal" 
                                               value="{{ form.data_inicio_mensal.value|date:'Y-m-d'|default:'' }}"
                                               min="{{ today|date:'Y-m-d' }}"
                                               class="text-base mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-white">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configurações do Relatório -->
                <div class="bg-white dark:bg-gray-800 shadow rounded-lg" id="config-relatorio" style="display: none;">
                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
                            Configurações do Relatório
                        </h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="formato" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                    Formato de Saída
                                </label>
                                <select name="formato" id="formato" 
                                        class="text-base mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-white">
                                    <option value="pdf" {% if form.formato.value == 'pdf' %}selected{% endif %}>PDF</option>
                                    <option value="excel" {% if form.formato.value == 'excel' %}selected{% endif %}>Excel</option>
                                    <option value="csv" {% if form.formato.value == 'csv' %}selected{% endif %}>CSV</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="periodo_dados" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                    Período dos Dados
                                </label>
                                <select name="periodo_dados" id="periodo_dados" 
                                        class="text-base mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-white">
                                    <option value="dia_anterior" {% if form.periodo_dados.value == 'dia_anterior' %}selected{% endif %}>Dia Anterior</option>
                                    <option value="semana_anterior" {% if form.periodo_dados.value == 'semana_anterior' %}selected{% endif %}>Semana Anterior</option>
                                    <option value="mes_anterior" {% if form.periodo_dados.value == 'mes_anterior' %}selected{% endif %}>Mês Anterior</option>
                                    <option value="personalizado" {% if form.periodo_dados.value == 'personalizado' %}selected{% endif %}>Personalizado</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Filtros Dinâmicos do Template -->
                        <div id="filtros-template">
                            <!-- Filtros serão carregados dinamicamente -->
                        </div>
                    </div>
                </div>

                <!-- Opções de Entrega -->
                <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
                    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
                            Opções de Entrega
                        </h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="enviar_email" name="enviar_email" value="1"
                                   {% if form.enviar_email.value %}checked{% endif %}
                                   class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <label for="enviar_email" class="ml-2 block text-sm text-gray-900 dark:text-white">
                                Enviar por email quando concluído
                            </label>
                        </div>
                        
                        <div class="ml-6" id="emails-config" {% if not form.enviar_email.value %}style="display: none;"{% endif %}>
                            <div class="space-y-4">
                                <div>
                                    <label for="emails_destinatarios" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        Destinatários (separados por vírgula)
                                    </label>
                                    <textarea name="emails_destinatarios" id="emails_destinatarios" rows="3"
                                              placeholder="email1@exemplo.com, email2@exemplo.com"
                                              class="text-base mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-white">{{ form.emails_destinatarios.value|default:'' }}</textarea>
                                </div>
                                
                                <div>
                                    <label for="assunto_email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        Assunto do Email
                                    </label>
                                    <input type="text" name="assunto_email" id="assunto_email" 
                                           value="{{ form.assunto_email.value|default:'Relatório Automático - [NOME_TEMPLATE]' }}"
                                           class="text-base mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-white">
                                </div>
                                
                                <div>
                                    <label for="corpo_email" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                                        Mensagem (opcional)
                                    </label>
                                    <textarea name="corpo_email" id="corpo_email" rows="3"
                                              placeholder="Relatório gerado automaticamente em [DATA_EXECUCAO]..."
                                              class="text-base mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-white">{{ form.corpo_email.value|default:'' }}</textarea>
                                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                                        Variáveis disponíveis: [NOME_TEMPLATE], [DATA_EXECUCAO], [FORMATO]
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center">
                            <input type="checkbox" id="ativo" name="ativo" value="1"
                                   {% if form.ativo.value or not form.ativo.value %}checked{% endif %}
                                   class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                            <label for="ativo" class="ml-2 block text-sm text-gray-900 dark:text-white">
                                Ativar agendamento imediatamente
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Botões de Ação -->
                <div class="flex justify-end space-x-4">
                    <a href="{% url 'relatorios:agendamento_lista' %}" 
                       class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                        <i class="fas fa-times mr-2"></i>
                        Cancelar
                    </a>
                    
                    <button type="button" 
                            class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600"
                            onclick="previewAgendamento()">
                        <i class="fas fa-eye mr-2"></i>
                        Preview
                    </button>
                    
                    <button type="submit" 
                            class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <i class="fas fa-save mr-2"></i>
                        Criar Agendamento
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Eventos de checkbox
    document.getElementById('enviar_email').addEventListener('change', function() {
        const emailsConfig = document.getElementById('emails-config');
        emailsConfig.style.display = this.checked ? 'block' : 'none';
    });
    
    // Carregar configurações se template já selecionado
    const templateSelect = document.getElementById('template');
    if (templateSelect.value) {
        carregarConfiguracoes();
    }
    
    // Configurar frequência inicial
    const frequenciaChecked = document.querySelector('input[name="frequencia"]:checked');
    if (frequenciaChecked) {
        alterarFrequencia(frequenciaChecked.value);
    }
});

function alterarFrequencia(frequencia) {
    // Ocultar todas as configurações
    document.getElementById('config-unica').style.display = 'none';
    document.getElementById('config-diaria').style.display = 'none';
    document.getElementById('config-semanal').style.display = 'none';
    document.getElementById('config-mensal').style.display = 'none';
    
    // Mostrar configuração específica
    if (frequencia === 'unica') {
        document.getElementById('config-unica').style.display = 'grid';
    } else if (frequencia === 'diaria') {
        document.getElementById('config-diaria').style.display = 'grid';
    } else if (frequencia === 'semanal') {
        document.getElementById('config-semanal').style.display = 'block';
    } else if (frequencia === 'mensal') {
        document.getElementById('config-mensal').style.display = 'block';
    }
}

function carregarConfiguracoes() {
    const templateId = document.getElementById('template').value;
    if (!templateId) {
        document.getElementById('config-relatorio').style.display = 'none';
        return;
    }
    
    document.getElementById('config-relatorio').style.display = 'block';
    
    fetch(`/relatorios/template-config/${templateId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Atualizar formato padrão
                document.getElementById('formato').value = data.template.formato_padrao;
                
                // Carregar filtros do template
                carregarFiltrosTemplate(data.template.filtros_disponiveis);
            }
        })
        .catch(error => {
            console.error('Erro ao carregar configurações:', error);
        });
}

function carregarFiltrosTemplate(filtros) {
    const container = document.getElementById('filtros-template');
    container.innerHTML = '';
    
    if (!filtros || filtros.length === 0) {
        return;
    }
    
    const titulo = document.createElement('h4');
    titulo.className = 'text-md font-medium text-gray-900 dark:text-white mb-4 border-t border-gray-200 dark:border-gray-700 pt-4';
    titulo.textContent = 'Filtros do Template';
    container.appendChild(titulo);
    
    const grid = document.createElement('div');
    grid.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
    
    filtros.forEach(filtro => {
        const div = document.createElement('div');
        
        const label = document.createElement('label');
        label.className = 'block text-sm font-medium text-gray-700 dark:text-gray-300';
        label.textContent = filtro.label || filtro.field;
        
        let input;
        
        switch (filtro.type) {
            case 'data':
                input = document.createElement('input');
                input.type = 'date';
                break;
            case 'numero':
                input = document.createElement('input');
                input.type = 'number';
                break;
            case 'escolha':
                input = document.createElement('select');
                if (filtro.options) {
                    filtro.options.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option.value;
                        opt.textContent = option.label;
                        input.appendChild(opt);
                    });
                }
                break;
            default:
                input = document.createElement('input');
                input.type = 'text';
        }
        
        input.name = `template_filtro_${filtro.field}`;
        input.className = 'text-base mt-1 block w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:text-white';
        
        if (filtro.placeholder) {
            input.placeholder = filtro.placeholder;
        }
        
        div.appendChild(label);
        div.appendChild(input);
        grid.appendChild(div);
    });
    
    container.appendChild(grid);
}

function previewAgendamento() {
    const formData = new FormData(document.getElementById('form-agendamento'));
    
    // Validar campos obrigatórios
    const nome = formData.get('nome');
    const template = formData.get('template');
    
    if (!nome || !template) {
        alert('Preencha o nome e selecione um template primeiro');
        return;
    }
    
    // Mostrar preview das próximas execuções
    const frequencia = formData.get('frequencia');
    let mensagem = `Agendamento: ${nome}\n`;
    mensagem += `Template: ${document.querySelector('#template option:checked').textContent}\n`;
    mensagem += `Frequência: ${document.querySelector(`#freq_${frequencia} label h4`).textContent}\n`;
    
    // Calcular próximas execuções baseado na frequência
    // (simplificado - implementação completa seria mais complexa)
    
    alert(mensagem);
}
</script>
{% endblock %}